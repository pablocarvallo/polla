<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Pagos y Deuda</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <!-- Modo app en iOS (sin barra de Safari al agregar a pantalla de inicio) -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />

  <!-- Icono de la app (polla.png debe estar en el mismo repo) -->
  <link rel="apple-touch-icon" href="polla.png" />
  <link rel="icon" type="image/png" href="polla.png" />

  <style>
    :root {
      --bg: #f2f3f7;
      --card-bg: #ffffff;
      --accent: #3277ff;
      --accent-soft: #e3edff;
      --text-main: #111827;
      --text-muted: #6b7280;
      --border-subtle: #e5e7eb;
      --danger: #e11d48;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, sans-serif;
      background: var(--bg);
      color: var(--text-main);
      -webkit-font-smoothing: antialiased;
    }

    .app {
      min-height: 100vh;
      max-width: 600px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      background: var(--bg);
    }

    .main {
      flex: 1;
      position: relative;
      overflow: hidden;
    }

    .screen {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      opacity: 0;
      pointer-events: none;
      transform: translateX(10px);
      transition: opacity 0.22s ease, transform 0.22s ease;
    }

    .screen.active {
      opacity: 1;
      pointer-events: auto;
      transform: translateX(0);
    }

    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 16px 8px;
      padding-top: calc(env(safe-area-inset-top, 0px) + 10px);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      background: rgba(242,243,247,0.9);
      border-bottom: 1px solid var(--border-subtle);
      z-index: 10;
    }

    .top-title {
      font-size: 17px;
      font-weight: 600;
    }

    .top-button {
      border: none;
      background: transparent;
      font-size: 14px;
      color: var(--accent);
      padding: 6px 10px;
      border-radius: 999px;
    }

    .top-button:active {
      background: rgba(50,119,255,0.1);
    }

    .top-button-left {
      margin-right: 8px;
    }

    .content {
      flex: 1;
      overflow-y: auto;
      padding: 8px 16px 16px;
      padding-bottom: 24px;
    }

    .section-title {
      font-size: 15px;
      font-weight: 600;
      margin: 12px 0 6px;
    }

    .card {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 12px 14px;
      box-shadow: 0 10px 30px rgba(15,23,42,0.06);
      border: 1px solid rgba(148,163,184,0.18);
      margin-bottom: 10px;
    }

    .row-inline {
      display: flex;
      gap: 8px;
    }

    .row-inline > * {
      flex: 1;
    }

    .field {
      margin-bottom: 10px;
    }

    .field label {
      display: block;
      font-size: 12px;
      font-weight: 500;
      color: var(--text-muted);
      margin-bottom: 3px;
    }

    .field input,
    .field select,
    .field textarea {
      width: 100%;
      border-radius: 12px;
      border: 1px solid var(--border-subtle);
      padding: 8px 10px;
      font-size: 14px;
      background: #f9fafb;
      outline: none;
    }

    .field textarea {
      min-height: 48px;
      resize: vertical;
    }

    .field input:focus,
    .field select:focus,
    .field textarea:focus {
      border-color: var(--accent);
      background: #ffffff;
      box-shadow: 0 0 0 1px rgba(50,119,255,0.14);
    }

    .field-checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .field-checkbox input {
      width: 18px;
      height: 18px;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--accent);
      font-size: 11px;
      font-weight: 500;
      margin-bottom: 6px;
    }

    .muted {
      font-size: 13px;
      color: var(--text-muted);
    }

    .primary-button {
      width: 100%;
      border-radius: 999px;
      border: none;
      padding: 10px 14px;
      font-size: 15px;
      font-weight: 600;
      background: var(--accent);
      color: #ffffff;
      margin-top: 2px;
    }

    .primary-button:active {
      opacity: 0.85;
    }

    .secondary-button {
      width: 100%;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      padding: 9px 14px;
      font-size: 14px;
      background: #f9fafb;
      color: var(--text-main);
      margin-top: 2px;
    }

    .secondary-button:active {
      background: #eceff3;
    }

    .item-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid rgba(226,232,240,0.7);
    }

    .item:last-child {
      border-bottom: none;
    }

    .item-main {
      max-width: 70%;
    }

    .item-line1 {
      font-size: 13px;
      font-weight: 600;
    }

    .item-line2 {
      font-size: 12px;
      color: var(--text-muted);
    }

    .item-amount {
      font-size: 14px;
      font-weight: 600;
    }

    .item-meta {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .chip-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 4px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .chip {
      padding: 2px 8px;
      border-radius: 999px;
      background: #e5e7eb;
    }

    .chip-strong {
      background: var(--accent-soft);
      color: var(--accent);
    }

    .debt-balance {
      font-size: 14px;
      font-weight: 600;
      margin-top: 4px;
    }

    .debt-balance span {
      font-weight: 700;
    }

    .debt-warning {
      font-size: 12px;
      color: var(--danger);
      margin-top: 4px;
    }

    .report-card h2 {
      margin-top: 0;
      font-size: 18px;
      margin-bottom: 4px;
    }

    .report-card h3 {
      margin: 10px 0 6px;
      font-size: 15px;
    }

    .report-card ul {
      padding-left: 18px;
      margin: 0 0 4px;
      font-size: 14px;
    }

    .report-card li {
      margin-bottom: 4px;
    }

    .report-note {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 8px;
    }

    .tab-bar {
      display: flex;
      align-items: center;
      justify-content: space-around;
      border-top: 1px solid var(--border-subtle);
      padding: 6px 16px 10px;
      padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 10px);
      background: rgba(248,249,252,0.96);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
    }

    .tab-button {
      flex: 1;
      border: none;
      background: transparent;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      padding-top: 2px;
      padding-bottom: 2px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .tab-button .tab-icon {
      font-size: 20px;
      line-height: 1;
    }

    .tab-button.active {
      color: var(--accent);
    }

    .tab-button.active .tab-icon {
      transform: translateY(-1px);
    }

    .tab-label {
      font-size: 11px;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #020617;
        --card-bg: #020617;
        --text-main: #e5e7eb;
        --text-muted: #9ca3af;
        --border-subtle: #1f2937;
        --accent-soft: rgba(50,119,255,0.18);
      }

      .card {
        box-shadow: 0 10px 30px rgba(0,0,0,0.65);
      }

      .field input,
      .field select,
      .field textarea {
        background: #020617;
        border-color: #111827;
      }

      .tab-bar,
      .top-bar {
        background: rgba(2,6,23,0.94);
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <main class="main">
      <!-- Pesta√±a 1: Liquidaci√≥n mensual -->
      <section id="screen-liquidacion" class="screen active">
        <header class="top-bar">
          <div class="top-title">Liquidaci√≥n mensual</div>
          <button id="btn-open-report" class="top-button">Reporte</button>
        </header>
        <div class="content">
          <div class="chip-row">
            <div class="pill" id="current-month-pill"></div>
            <div class="chip chip-strong" id="summary-chip"></div>
          </div>

          <h2 class="section-title">Nuevo pago</h2>
          <form id="form-income" class="card" autocomplete="off">
            <div class="field">
              <label for="income-date">Fecha</label>
              <input type="date" id="income-date" />
            </div>

            <div class="row-inline">
              <div class="field">
                <label for="income-amount">Monto ($)</label>
                <input type="text" id="income-amount" inputmode="decimal" placeholder="Ej: 150000" />
              </div>
              <div class="field">
                <label for="income-bank">Banco</label>
                <select id="income-bank">
                  <option value="itau">Ita√∫</option>
                  <option value="bch">BCH</option>
                </select>
              </div>
            </div>

            <div class="field">
              <label for="income-detail">Detalle</label>
              <input type="text" id="income-detail" placeholder="Ej: Transferencia mensual, pago deuda, etc." />
            </div>

            <div class="field-checkbox">
              <input type="checkbox" id="income-is-debt" />
              <label for="income-is-debt">Este pago es un pago de deuda (se refleja en BCH y usar√° el saldo pendiente de la pesta√±a Deuda)</label>
            </div>

            <button type="submit" class="primary-button">Agregar pago</button>
          </form>

          <h2 class="section-title">Pagos del mes</h2>
          <div class="card" id="card-incomes-list">
            <div id="incomes-list"></div>
          </div>
        </div>
      </section>

      <!-- Pesta√±a 2: Deuda -->
      <section id="screen-deuda" class="screen">
        <header class="top-bar">
          <div class="top-title">Deuda con mi esposa</div>
          <div style="width:52px;"></div>
        </header>
        <div class="content">
          <h2 class="section-title">Saldo inicial de la deuda</h2>
          <form id="form-debt-initial" class="card" autocomplete="off">
            <div class="field">
              <label for="debt-initial">Saldo inicial ($)</label>
              <input type="text" id="debt-initial" inputmode="decimal" placeholder="Ej: 1000000" />
            </div>
            <button type="submit" class="secondary-button">Guardar saldo inicial</button>
            <div class="debt-balance" id="debt-balance-text"></div>
            <div class="debt-warning" id="debt-warning-text"></div>
          </form>

          <h2 class="section-title">Registrar pago de deuda</h2>
          <form id="form-debt-payment" class="card" autocomplete="off">
            <div class="field">
              <label for="debt-payment-date">Fecha</label>
              <input type="date" id="debt-payment-date" />
            </div>

            <div class="field">
              <label for="debt-payment-amount">Monto pagado ($)</label>
              <input type="text" id="debt-payment-amount" inputmode="decimal" placeholder="Ej: 100000" />
            </div>

            <div class="field">
              <label for="debt-payment-detail">Detalle</label>
              <input type="text" id="debt-payment-detail" placeholder="Ej: Pago deuda noviembre" />
            </div>

            <button type="submit" class="primary-button">Registrar pago de deuda</button>
          </form>

          <h2 class="section-title">Historial de pagos de deuda</h2>
          <div class="card">
            <div id="debt-payments-list"></div>
          </div>
        </div>
      </section>

      <!-- Pantalla de reporte -->
      <section id="screen-report" class="screen">
        <header class="top-bar">
          <button id="btn-back-from-report" class="top-button top-button-left">‚Äπ Atr√°s</button>
          <div class="top-title">Reporte del mes</div>
          <button id="btn-share-report" class="top-button">Compartir</button>
        </header>
        <div class="content">
          <div id="report-content" class="card report-card">
            <!-- Se llena din√°micamente -->
          </div>
          <p class="report-note">
            El bot√≥n "Compartir" genera una imagen del reporte. Si el sistema no permite compartir directamente,
            se descargar√° la imagen para que puedas enviarla desde Fotos o Archivos.
          </p>
        </div>
      </section>
    </main>

    <!-- Barra de pesta√±as inferior -->
    <nav class="tab-bar">
      <button class="tab-button active" data-target="screen-liquidacion">
        <span class="tab-icon">üí∏</span>
        <span class="tab-label">Liquidaci√≥n</span>
      </button>
      <button class="tab-button" data-target="screen-deuda">
        <span class="tab-icon">üìâ</span>
        <span class="tab-label">Deuda</span>
      </button>
    </nav>
  </div>

  <!-- Librer√≠a para capturar el reporte como imagen -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <script>
    const STORAGE_KEY = "pagos_y_deuda_v1";

    let state = {
      incomes: [], // {id, date, amount, bank, detail, isDebtPayment}
      debt: {
        initialBalance: 0,
        payments: [] // {id, date, amount, detail}
      }
    };

    let currentTabId = "screen-liquidacion";

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        const parsed = JSON.parse(raw);
        if (parsed && typeof parsed === "object") {
          if (!parsed.incomes) parsed.incomes = [];
          if (!parsed.debt) parsed.debt = { initialBalance: 0, payments: [] };
          if (!Array.isArray(parsed.debt.payments)) parsed.debt.payments = [];
          state = parsed;
        }
      } catch (e) {
        console.error("Error al cargar estado:", e);
      }
    }

    function saveState() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      } catch (e) {
        console.error("Error al guardar estado:", e);
      }
    }

    function todayISO() {
      return new Date().toISOString().slice(0, 10);
    }

    function parseAmount(value) {
      if (!value) return NaN;
      let cleaned = String(value)
        .replace(/\s+/g, "")
        .replace(/\./g, "")
        .replace(/,/g, ".")
        .replace(/[^\d.]/g, "");
      if (!cleaned) return NaN;
      const num = parseFloat(cleaned);
      if (isNaN(num)) return NaN;
      return Math.round(num);
    }

    function formatCurrency(value) {
      const val = Number(value) || 0;
      try {
        return new Intl.NumberFormat("es-CL", {
          style: "currency",
          currency: "CLP",
          maximumFractionDigits: 0
        }).format(val);
      } catch {
        return "$" + val.toLocaleString("es-CL", { maximumFractionDigits: 0 });
      }
    }

    function formatShortDate(dateStr) {
      const d = new Date(dateStr);
      if (Number.isNaN(d.getTime())) return "";
      return d.toLocaleDateString("es-CL", { day: "2-digit", month: "short" });
    }

    function getCurrentMonthYearText() {
      const now = new Date();
      return now.toLocaleDateString("es-CL", {
        month: "long",
        year: "numeric"
      });
    }

    function escapeHtml(str) {
      if (!str) return "";
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function getPendingDebt() {
      const initial = Number(state.debt.initialBalance) || 0;
      const paid = state.debt.payments.reduce((sum, p) => {
        return sum + (Number(p.amount) || 0);
      }, 0);
      return Math.max(initial - paid, 0);
    }

    function setScreen(screenId, fromTab = false) {
      const screens = document.querySelectorAll(".screen");
      screens.forEach((s) => {
        s.classList.toggle("active", s.id === screenId);
      });

      if (fromTab) {
        currentTabId = screenId;
        const tabButtons = document.querySelectorAll(".tab-button");
        tabButtons.forEach((btn) => {
          const tgt = btn.getAttribute("data-target");
          btn.classList.toggle("active", tgt === screenId);
        });
      }
    }

    function renderMonthChip() {
      const pill = document.getElementById("current-month-pill");
      if (pill) {
        pill.textContent = getCurrentMonthYearText();
      }
    }

    function renderSummaryChip() {
      const chip = document.getElementById("summary-chip");
      const now = new Date();
      const m = now.getMonth();
      const y = now.getFullYear();
      const total = state.incomes.reduce((sum, inc) => {
        const d = new Date(inc.date);
        if (d.getMonth() === m && d.getFullYear() === y) {
          return sum + (Number(inc.amount) || 0);
        }
        return sum;
      }, 0);
      chip.textContent = "Total mes: " + formatCurrency(total);
    }

    function renderIncomesList() {
      const container = document.getElementById("incomes-list");
      const now = new Date();
      const m = now.getMonth();
      const y = now.getFullYear();

      const incomesThisMonth = state.incomes
        .filter((inc) => {
          const d = new Date(inc.date);
          return d.getMonth() === m && d.getFullYear() === y;
        })
        .sort((a, b) => new Date(a.date) - new Date(b.date));

      if (!incomesThisMonth.length) {
        container.innerHTML = '<p class="muted">Sin pagos registrados este mes.</p>';
        return;
      }

      let html = '<ul class="item-list">';
      incomesThisMonth.forEach((inc) => {
        const bankLabel = inc.bank === "bch" ? "BCH" : "Ita√∫";
        const dateLabel = formatShortDate(inc.date);
        const debtTag = inc.isDebtPayment ? " ¬∑ Pago deuda" : "";
        html += `
          <li class="item">
            <div class="item-main">
              <div class="item-line1">${bankLabel}${debtTag}</div>
              <div class="item-line2">${escapeHtml(inc.detail || "")}</div>
              <div class="item-meta">${escapeHtml(dateLabel)}</div>
            </div>
            <div class="item-amount">${formatCurrency(inc.amount)}</div>
          </li>
        `;
      });
      html += "</ul>";
      container.innerHTML = html;
    }

    function renderDebtPanel() {
      const balanceText = document.getElementById("debt-balance-text");
      const warningText = document.getElementById("debt-warning-text");
      const initial = Number(state.debt.initialBalance) || 0;
      const pending = getPendingDebt();

      if (initial <= 0) {
        balanceText.textContent = "Define un saldo inicial para comenzar a registrar pagos.";
        warningText.textContent = "";
        return;
      }

      balanceText.innerHTML =
        'Saldo inicial: <span>' +
        formatCurrency(initial) +
        "</span> ¬∑ Pendiente: <span>" +
        formatCurrency(pending) +
        "</span>";
      if (pending === 0) {
        warningText.textContent = "Deuda completamente pagada.";
      } else if (pending < initial * 0.2) {
        warningText.textContent = "La deuda est√° cercana a terminarse.";
      } else {
        warningText.textContent = "";
      }

      const inputInitial = document.getElementById("debt-initial");
      if (inputInitial && !inputInitial.value) {
        inputInitial.value = initial > 0 ? initial : "";
      }
    }

    function renderDebtPaymentsList() {
      const container = document.getElementById("debt-payments-list");
      const payments = state.debt.payments
        .slice()
        .sort((a, b) => new Date(a.date) - new Date(b.date));

      if (!payments.length) {
        container.innerHTML = '<p class="muted">A√∫n no hay pagos de deuda registrados.</p>';
        return;
      }

      let html = '<ul class="item-list">';
      payments.forEach((p) => {
        const dateLabel = formatShortDate(p.date);
        html += `
          <li class="item">
            <div class="item-main">
              <div class="item-line1">${escapeHtml(p.detail || "Pago de deuda")}</div>
              <div class="item-meta">${escapeHtml(dateLabel)}</div>
            </div>
            <div class="item-amount">${formatCurrency(p.amount)}</div>
          </li>
        `;
      });
      html += "</ul>";
      container.innerHTML = html;
    }

    function buildReportContent() {
      const container = document.getElementById("report-content");
      const now = new Date();
      const m = now.getMonth();
      const y = now.getFullYear();
      const title = getCurrentMonthYearText();

      const incomesThisMonth = state.incomes
        .filter((inc) => {
          const d = new Date(inc.date);
          return d.getMonth() === m && d.getFullYear() === y;
        })
        .sort((a, b) => new Date(a.date) - new Date(b.date));

      const itau = incomesThisMonth.filter((i) => i.bank === "itau");
      const bch = incomesThisMonth.filter((i) => i.bank === "bch");
      const pendingDebt = getPendingDebt();

      let totalMonth = incomesThisMonth.reduce((sum, i) => {
        return sum + (Number(i.amount) || 0);
      }, 0);

      let html = "";
      html += `<h2>${escapeHtml(title)}</h2>`;
      html += `<p class="muted">Resumen de pagos del mes ¬∑ Total: <strong>${formatCurrency(
        totalMonth
      )}</strong></p>`;

      if (!incomesThisMonth.length) {
        html += `<p class="muted">No hay pagos registrados para este mes.</p>`;
        container.innerHTML = html;
        return;
      }

      html += `<h3>Banco Ita√∫</h3>`;
      if (!itau.length) {
        html += `<p class="muted">Sin pagos en Ita√∫.</p>`;
      } else {
        html += "<ul>";
        itau.forEach((inc) => {
          html += `<li>${escapeHtml(inc.detail || "Pago")}; ${formatCurrency(
            inc.amount
          )}</li>`;
        });
        html += "</ul>";
      }

      html += `<h3>BCH</h3>`;
      if (!bch.length) {
        html += `<p class="muted">Sin pagos en BCH.</p>`;
      } else {
        html += "<ul>";
        bch.forEach((inc) => {
          const isDebt = inc.isDebtPayment;
          const label = escapeHtml(inc.detail || (isDebt ? "Pago deuda" : "Pago"));
          if (isDebt) {
            html += `<li>${label} (pendiente: ${formatCurrency(
              pendingDebt
            )}); ${formatCurrency(inc.amount)}</li>`;
          } else {
            html += `<li>${label}; ${formatCurrency(inc.amount)}</li>`;
          }
        });
        html += "</ul>";
      }

      html += `<p class="report-note">El saldo pendiente mostrado en los pagos de deuda se obtiene desde la pesta√±a "Deuda" (saldo inicial menos pagos de deuda registrados).</p>`;

      container.innerHTML = html;
    }

    async function shareReportImage() {
      const reportEl = document.getElementById("report-content");
      if (!reportEl) return;

      try {
        window.scrollTo(0, 0);

        const canvas = await html2canvas(reportEl, {
          scale: 2,
          backgroundColor: null
        });

        const blob = await new Promise((resolve) =>
          canvas.toBlob(resolve, "image/png")
        );
        if (!blob) throw new Error("No se pudo generar la imagen");

        const file = new File([blob], "reporte-liquidacion.png", {
          type: "image/png"
        });

        if (navigator.canShare && navigator.canShare({ files: [file] })) {
          await navigator.share({
            files: [file],
            title: "Reporte de liquidaci√≥n",
            text: "Resumen mensual de pagos y deuda."
          });
        } else {
          const url = URL.createObjectURL(blob);
          const link = document.createElement("a");
          link.href = url;
          link.download = "reporte-liquidacion.png";
          document.body.appendChild(link);
          link.click();
          link.remove();
          URL.revokeObjectURL(url);
          alert(
            "La imagen del reporte se descarg√≥. Puedes compartirla desde Fotos o Archivos."
          );
        }
      } catch (err) {
        console.error(err);
        alert("Ocurri√≥ un problema al generar la imagen del reporte.");
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      loadState();

      const inputIncomeDate = document.getElementById("income-date");
      const inputDebtPayDate = document.getElementById("debt-payment-date");
      if (inputIncomeDate && !inputIncomeDate.value) {
        inputIncomeDate.value = todayISO();
      }
      if (inputDebtPayDate && !inputDebtPayDate.value) {
        inputDebtPayDate.value = todayISO();
      }

      renderMonthChip();
      renderSummaryChip();
      renderIncomesList();
      renderDebtPanel();
      renderDebtPaymentsList();

      const tabButtons = document.querySelectorAll(".tab-button");
      tabButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          const target = btn.getAttribute("data-target");
          if (!target) return;
          setScreen(target, true);
        });
      });

      const formIncome = document.getElementById("form-income");
      formIncome.addEventListener("submit", (e) => {
        e.preventDefault();
        const date = inputIncomeDate.value || todayISO();
        const amountRaw = document.getElementById("income-amount").value;
        const bank = document.getElementById("income-bank").value;
        const detail = document.getElementById("income-detail").value.trim();
        const isDebt = document.getElementById("income-is-debt").checked;

        const amount = parseAmount(amountRaw);
        if (isNaN(amount) || amount <= 0) {
          alert("Ingresa un monto v√°lido para el pago.");
          return;
        }

        state.incomes.push({
          id: Date.now().toString() + Math.random().toString(16).slice(2),
          date,
          amount,
          bank,
          detail,
          isDebtPayment: isDebt
        });

        saveState();

        document.getElementById("income-amount").value = "";
        document.getElementById("income-detail").value = "";
        document.getElementById("income-is-debt").checked = false;

        renderSummaryChip();
        renderIncomesList();
      });

      const formDebtInitial = document.getElementById("form-debt-initial");
      formDebtInitial.addEventListener("submit", (e) => {
        e.preventDefault();
        const raw = document.getElementById("debt-initial").value;
        const amount = parseAmount(raw);
        if (isNaN(amount) || amount < 0) {
          alert("Ingresa un saldo inicial v√°lido.");
          return;
        }
        state.debt.initialBalance = amount;
        saveState();
        renderDebtPanel();
      });

      const formDebtPayment = document.getElementById("form-debt-payment");
      formDebtPayment.addEventListener("submit", (e) => {
        e.preventDefault();
        const date = inputDebtPayDate.value || todayISO();
        const amountRaw = document.getElementById("debt-payment-amount").value;
        const detail = document
          .getElementById("debt-payment-detail")
          .value.trim();

        const amount = parseAmount(amountRaw);
        if (isNaN(amount) || amount <= 0) {
          alert("Ingresa un monto de pago v√°lido.");
          return;
        }

        state.debt.payments.push({
          id: Date.now().toString() + Math.random().toString(16).slice(2),
          date,
          amount,
          detail
        });

        saveState();

        document.getElementById("debt-payment-amount").value = "";
        document.getElementById("debt-payment-detail").value = "";
        if (!inputDebtPayDate.value) {
          inputDebtPayDate.value = todayISO();
        }

        renderDebtPanel();
        renderDebtPaymentsList();
      });

      const btnOpenReport = document.getElementById("btn-open-report");
      btnOpenReport.addEventListener("click", () => {
        buildReportContent();
        setScreen("screen-report", false);
      });

      const btnBackFromReport = document.getElementById("btn-back-from-report");
      btnBackFromReport.addEventListener("click", () => {
        setScreen(currentTabId, false);
      });

      const btnShareReport = document.getElementById("btn-share-report");
      btnShareReport.addEventListener("click", shareReportImage);
    });
  </script>
</body>
</html>
